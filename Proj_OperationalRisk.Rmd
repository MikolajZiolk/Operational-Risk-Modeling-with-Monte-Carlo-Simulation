---
title: "Zad3_RyzykoOperacyjny"
author: "Mikołaj Ziółkowski, Tomasz Sałapatek"
date: today
editor: visual
format: 
  html:
    toc: true
    toc-depth: 3
    toc-location: left
    toc-title: Spis Treści
    number-sections: true
    number-depth: 3
    embed-resources: true
    html-math-method: katex
    code-tools: true
    code-block-bg: true
    code-fold: true
    code-summary: "Show and hide code"
    link-external-icon: true
    link-external-newwindow: true
    smooth-scroll: true
    self-contained: true
    fontsize: 1.0em
    linestretch: 1.3
    fig-align: center
execute: 
  echo: true
  error: false
  warning: false
  output: true
editor_options: 
  chunk_output_type: console
---

<style type="text/css"> body {text-align: justify} </style>

# Wstęp

## Dane

Początkowo ładujemy potrzebne biblioteki, takie jak:

\- distr

\- tidyr

\- dplyr

\- MASS

\- fitdistrplus

\- knitr

\- kableExtra

<br> Następnie pobieramy dane dotyczące wysokości strat brutto dla wybranego okresu oraz kategorii ryzyka. Dane zawierają kolumny takie jak rok, strata, linia. W kolumnie linia znajduje się 7 linii biznesowych: BussDistr, Com_Ban, Damage Empl_Pract, Execut_Del, External_Fr, Internal_Fr. <br> Poniżej 6 pierwszych rekordów:

```{r}
library(distr)
library(tidyr)
library(dplyr)
library(MASS)
library(fitdistrplus)
library(knitr)
library(kableExtra)

plik28 <- read.csv("C:/Users/mikol/OneDrive/Desktop/Modelowanie Ryzyka KiU/zad3/plik28.csv", sep=";")


plik28 <- plik28 |> 
  mutate(strata = as.numeric(strata))

head(plik28)

```

# linia Buss_Distr

## Rozkład częstotliwości

Mowa tu o częstotliwości z którą dana kategoria ryzyka występowała na przestrzeni roku. Będziemy starali się bazie danych historycznych przyporządkować tym danym najbardziej odpowiadający im model. W taki sposób, aby móc w przyszłości przeprowadzić symulację.

W przyporządkowaniu rozkładów sugerowaliśmy się zasadą przytoczoną na wykładzie, mianowicie: <br> - EX \>𝐷2𝑋 rozkład dwumianowy <br> - E𝑋 =𝐷2𝑋 rozkład Poissona <br> - E𝑋 \<𝐷2𝑋 rozkład ujemny dwumianowy <br>

```{r}
rok_BussDistr <- plik28 %>%
  filter( linia == "Buss_Distr") %>%
  group_by(rok) %>%
  summarize(liczba_zdarzen = n())

straty_BussDistr <- plik28 %>%
  filter(linia == "Buss_Distr") %>%
  group_by(rok) %>%
  summarize(straty = sum(strata, na.rm = TRUE))

BussDistr_summary <- merge(rok_BussDistr, straty_BussDistr, by = "rok")

kable(BussDistr_summary, format = "html", caption = "Podsumowanie dla liniii Buss_Distr") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)


```

Rozkłady częstotliwości w zależności od roku oraz strat w zależności od linii biznesowych. Filtrujemy dane tylko do Buss_Distr. DLa tej linii liczymy liczbę zdarzeń operacyjnych w każdym roku oraz sumę strat rocznych.

```{r}
mean_BussDistr = mean(rok_BussDistr$liczba_zdarzen)
sd_BussDistr = sd(rok_BussDistr$liczba_zdarzen)

mean_BussDistr
sd_BussDistr
```

## Rozkład zdarzeń

Średnia i odchylenie standardowe wynoszą kolejno: 10,657 oraz 4,485. Zgodnie z zasadą przytoczoną wcześniej przyporządkowaliśmy temu rozkład ujemny dwumianowy. Dla pewności, sprawdźmy jeszcze dopasowanie funkcją "fitdistr":

```{r}
BussDistr_fit <- fitdist(rok_BussDistr$liczba_zdarzen, "nbinom")
gofstat(BussDistr_fit)
```

p-value wynosi 0,208 z tego powodu nie ma podstaw do odrzucenia hipotezy i możemy uznać rozkład ujemny dwumianowy za dobrze dopasowany. Dla pewności zobaczymy to jeszcze na wykresie:

```{r}
plot(fitdist(rok_BussDistr$liczba_zdarzen, "nbinom"))
```

Dopasowanie zdecydowanie nie jest idealne. Wartości empiryczne rozjeżdżają się z teoretycznymi zwłaszcza na środku.

## Rozkład strat

Ponownie, sprawdźmy dopasowanie funkcją fitdist, tym razem sprawdzamy dopasowanie rozkładu dotkliwości strat do rozkładów lnorm, exp oraz gamma. Dopasowanie metodą momentów (mme)

```{r}
BussDistr2 <- fitdist(straty_BussDistr$straty, method="mme","lnorm")
BussDistr3 <- fitdist(straty_BussDistr$straty, method="mme","exp")
BussDistr4 <- fitdist(straty_BussDistr$straty, method="mme","gamma")
names_test = c("lnorm", "exp", "gamma")

Result_BussDist<-gofstat(list(BussDistr2, BussDistr3, BussDistr4), fitnames=names_test)
Result_BussDist$chisqpvalue
Result_BussDist$adtest
Result_BussDist$kstest
```

Zarówno rozkład lnorm jak i gamma mógłby być dobrym kandydatem. Z tego powodu, zobaczmy to na wykresie.

-   Dla gammy:

```{r}
plot(fitdist(straty_BussDistr$straty, "gamma"))
```

-   Dla lnorm:

```{r}
plot(fitdist(straty_BussDistr$straty, "lnorm"))

```

Na wykresie możemy zobaczyć, że rozkład teoretyczny **lnorm**, nieco lepiej odzwerciedla rozkład naszyh danych, więc to jego wybierzemy do dalszych badań.

## Symulacja

Przeprowadziliśmy symulację metodą Monte Carlo bazując na dwóch wcześniej wybranych rozkładach - dwumianowy ujemny oraz logarytmiczno - normalny.

```{r}
set.seed(123)

nbinom_params <- BussDistr_fit$estimate 
size_param <- nbinom_params["size"]
mu_param <- nbinom_params["mu"]

lnorm_params <- BussDistr2$estimate
meanlog <- lnorm_params["meanlog"]
sdlog <- lnorm_params["sdlog"]

```

Parametry dopasowane metodą maksymalnej wiarygodności dla rozkładu ujemnego dwumianowego: <br> size = 12.23<br> mu = 10.66<br>

Parametry dopasowania log-norm:<br> meanlog = 13.08<br> sdlog = 0.40<br> <br> <br>

W pierwszej kolejności symulujemy 20000 scenariuszy rocznych strat. Losujemy liczbę zdarzeń z rozkładu ujemnego dwumianowego. Dla każdej liczby zdarzeń losujemy odpowiednią liczbę strat z rozkładu log-normalnego. Sumujemy je = to jedna realizacja rocznej straty.

```{r}
n_sim <- 20000 

symulacje_BussDist <- replicate(n_sim, {
  liczba_zdarzen <- rnbinom(1, size = size_param, mu = mu_param)
  if (liczba_zdarzen == 0) return(0)
  sum(rlnorm(liczba_zdarzen, meanlog = meanlog, sdlog = sdlog))
})

```

Następnie na podstawie rozkładu symulowanego obliczamy OpVaR(99.9%) oraz OpES(99.9%).

```{r}
OpVaR_999_BussDist <- quantile(symulacje_BussDist, 0.999)
OpES_999_BussDist <- mean(symulacje_BussDist[symulacje_BussDist > OpVaR_999_BussDist])

#histogramu rozkładu symulowanych strat:
hist_BussDist <-hist(symulacje_BussDist, breaks = 100, col = "lightblue", main = "Symulowany rozkład strat rocznych", xlab = "Suma strat")
abline(v = OpVaR_999_BussDist, col = "red", lwd = 2, lty = 2)


cat("OpVaR (99.9%) =", OpVaR_999_BussDist, "\n")
cat("OpES  (99.9%) =", OpVaR_999_BussDist, "\n")

```

Na podstawie symulacji sporządziliśmy histogram symulowanego rozkładu strat, a na nim zaznaczona jest wartość OpVaR. Na osi X mamy wielkość straty, a na osi Y częstotliwość tych strat. Widzimy, że rozkład jest mocno prawoskośny z długimi ogonami. Większość strat wynosi ok. 5000000.

# linia Com_Ban

## Rozkład częstotliwości

```{r}
rok_Com_Ban <- plik28 |>
  filter( linia == "Com_Ban") |>
  group_by(rok) |>
  summarize(liczba_zdarzen = n())

straty_Com_Ban <- plik28 |>
  filter(linia == "Com_Ban") |>
  group_by(rok) |>
  summarize(straty = sum(strata, na.rm = TRUE))

Com_Ban_summary <- merge(rok_Com_Ban, straty_Com_Ban, by = "rok")

kable(Com_Ban_summary, format = "html", caption = "Podsumowanie dla liniii Com_Ban") |> 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

```

Początkowo dane zostały przefiltrowane dla liniii Com_Ban. Dla każdego roku obliczono liczbę zdarzeń oraz sumę strat.

```{r}
mean_Com_Ban = mean(rok_Com_Ban$liczba_zdarzen)
sd_Com_Ban = sd(rok_Com_Ban$liczba_zdarzen)

mean_Com_Ban
sd_Com_Ban
```

Średnia liczba zdarzeń to 6.2 a odchylenie standardowe 2.08. Na tej podstawie dopasowujemy rozkład dwumianowy, ponieważ gdy E(X) \> D\^2(X) to ta cecha wskazuje na ta taki rozkład.

## Rozkład zdarzeń

Przyporządkowaliśmy rozkład dwumianowy, z parametrem size=100. Dla pewności, sprawdźmy jeszcze dopasowanie funkcją "fitdistr":

```{r}
size_value <- 100
Com_Ban_fit <- fitdist(rok_Com_Ban$liczba_zdarzen, "binom",fix.arg = list(size = size_value))
gofstat(Com_Ban_fit)

```

p-value wynosi 0,78 z tego powodu nie ma podstaw do odrzucenia hipotezy i możemy uznać rozkład dwumianowy za dobrze dopasowany. Dla pewności zobaczymy to jeszcze na wykresie:

```{r}
plot(Com_Ban_fit)
```

Na czerwono widzimy rozkład teoretyczny, a na czarno empiryczny. Nie jest to dopasowanie idealne, ale podobne.

## Rozkład strat

Teraz będziemy sprawdzać dopasowanie funkcją fitdist, tym razem sprawdzamy dopasowanie rozkładu dotkliwości strat do rozkładów lnorm, exp oraz gamma. Dopasowanie metodą momentów (mme)

```{r}
Com_Ban2 <- fitdist(straty_Com_Ban$straty, method="mme","lnorm")
Com_Ban3 <- fitdist(straty_Com_Ban$straty, method="mme","exp")
Com_Ban4 <- fitdist(straty_Com_Ban$straty, method="mme","gamma")
names_test = c("lnorm", "exp", "gamma")

Result_Com_Ban<-gofstat(list(Com_Ban2, Com_Ban3, Com_Ban4), fitnames=names_test)
Result_Com_Ban$chisqpvalue
Result_Com_Ban$adtest
Result_Com_Ban$kstest
```

Ponownie zarówno rozkład lnorm jak i gamma mógłby być dobrym kandydatem. Z tego powodu, zobaczmy to na wykresie.

-   Dla gammy:

```{r}
plot(fitdist(straty_Com_Ban$straty, "gamma"))

```

-   Dla lnorm:

```{r}
plot(fitdist(straty_Com_Ban$straty, "lnorm"))
```

Na wykresie możemy zobaczyć, że rozkład teoretyczny gamma lepiej się dopasowuje, decydujemy się na wybór **gamma**.

## Symulacja

Symulacja metodą Monte Carlo bazująca na dwóch wcześniej wybranych rozkładach - dwumianowy oraz gamma.

```{r}
set.seed(123)
binom_params <- Com_Ban_fit$estimate 
prob_param <- binom_params["prob"]

gamma_params <- Com_Ban4$estimate
rate <- gamma_params["rate"]
shape <- gamma_params["shape"]
```

Parametry dopasowane metodą maksymalnej wiarygodności dla rozkładu dwumianowgo: <br> prob_param = 0.06<br>

Parametry dopasowania gamma:<br> shape = 3.633469e+00<br> rate = 2.441848e-05<br>

<br> <br>

Symulujemy 20000 scenariuszy rocznych strat. Do każdej symulacji wylosowano liczbę zdarzeń z rozkładu dwumianowego. Dla każdej liczby zdarzeń losujemy odpowiednią liczbę strat z rozkładu gamma.

```{r}
n_sim <- 20000
size_param_binom <- 100

symulacje_Com_Ban <- replicate(n_sim, {
  liczba_zdarzen <- rbinom(1, size = size_param_binom, prob = prob_param)
  if (liczba_zdarzen == 0) return(0)
  sum(rexp(liczba_zdarzen, rate = rate))
})

```

Następnie na podstawie rozkładu symulowanego obliczamy OpVaR(99.9%) oraz OpES(99.9%).

```{r}
OpVaR_999_Com_Ban <- quantile(symulacje_Com_Ban, 0.999)
OpES_999_Com_Ban <- mean(symulacje_Com_Ban[symulacje_Com_Ban > OpVaR_999_Com_Ban])

hist_Com_Ban <-hist(symulacje_Com_Ban, breaks = 100, col = "lightblue",
     main = "Symulowany rozkład strat rocznych (Com_Ban)",
     xlab = "Suma strat")
abline(v = OpVaR_999_Com_Ban, col = "red", lwd = 2, lty = 2)

cat("OpVaR (99.9%) = ", OpVaR_999_Com_Ban, "\n")
cat("OpES  (99.9%) = ", OpES_999_Com_Ban, "\n")

```

Sporządziliśmy histogram symulowanego rozkładu strat, a na nim zaznaczona jest wartość OpVaR. Na osi X mamy wielkość straty, a na osi Y częstotliwość tych strat. Widzimy, że rozkład jest mocno prawoskośny z długimi ogonami. Większość strat wynosi ok. 200000.

# linia Damage

## Rozkład częstotliwości

```{r}
rok_Damage <- plik28 |>
  filter( linia == "Damage") |>
  group_by(rok) |>
  summarize(liczba_zdarzen = n())

straty_Damage <- plik28 |>
  filter(linia == "Damage") |>
  group_by(rok) |>
  summarize(straty = sum(strata, na.rm = TRUE))

Damage_summary <- merge(rok_Damage, straty_Damage, by = "rok")

kable(Damage_summary, format = "html", caption = "Podsumowanie dla liniii Damage") |> 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

```

Dane zostały przefiltrowane dla liniii Damage. Dla każdego roku obliczono liczbę zdarzeń oraz sumę strat.

```{r}
mean_Damage = mean(rok_Damage$liczba_zdarzen)
sd_Damage = sd(rok_Damage$liczba_zdarzen)

mean_Damage
sd_Damage
```

Średnia liczba zdarzeń to 14.09 a odchylenie standardowe 3.04. Na tej podstawie dopasowujemy rozkład dwumianowy, ponieważ gdy E(X) \> D\^2(X).

## Rozkład zdarzeń

Przyporządkowaliśmy rozkład dwumianowy, z parametrem size=100. Dla pewności, sprawdźmy jeszcze dopasowanie funkcją "fitdistr":

```{r}
Damage_fit <- fitdist(rok_Damage$liczba_zdarzen, "binom",fix.arg = list(size = size_value))
gofstat(Damage_fit)
```

p-value wynosi 0,35 z tego powodu nie ma podstaw do odrzucenia hipotezy zerowej i możemy uznać rozkład dwumianowy za dobrze dopasowany. Dla pewności zobaczymy to jeszcze na wykresie:

```{r}
plot(Damage_fit)
```

Widzimy, że zwłaszcza koło 14 rozkłady sporo się rozjeżdżają, ale poza nią są całkiem nieźle dopasowane do siebie.

## Rozkład strat

Będziemy sprawdzać dopasowanie funkcją fitdist, sprawdzamy dopasowanie rozkładu dotkliwości strat do rozkładów lnorm, exp oraz gamma. Dopasowanie metodą momentów (mme)

```{r}
Damage2 <- fitdist(straty_Damage$straty, method="mme","lnorm")
Damage3 <- fitdist(straty_Damage$straty, method="mme","exp")
Damage4 <- fitdist(straty_Damage$straty, method="mme","gamma")
names_test = c("lnorm", "exp", "gamma")

Result_Damage<-gofstat(list(Damage2, Damage3, Damage4), fitnames=names_test)
Result_Damage$chisqpvalue
Result_Damage$adtest
Result_Damage$kstest
```

Żaden test nie odrzuca dopasowania. Z tego powodu zobaczmy to na wykresie.

-   Dla gammy:

```{r}
plot(fitdist(straty_Com_Ban$straty, "gamma"))
```

-   Dla lnorm:

```{r}
plot(fitdist(straty_Com_Ban$straty, "lnorm"))
```

-   Dla exp:

```{r}
plot(fitdist(straty_Damage$straty, "exp"))
```

Na wykresie możemy zobaczyć, że rozkład teoretyczny exp najlepiej się dopasowuje, decydujemy się na wybór **exp**.

## Symulacja

Symulacja metodą Monte Carlo bazująca na dwóch wcześniej wybranych rozkładach - dwumianowy oraz exp.

```{r}
set.seed(123)
binom_params2 <- Damage_fit$estimate 
prob_param2 <- binom_params2["prob"]

exp_params2 <- Damage3$estimate
rate2 <- exp_params2["rate"]
```

Parametry dla rozkładu dwumianowgo: <br> prob = 0.14<br>

Parametry dopasowania exp:<br> 1.034058e-05<br>

<br> <br>

Symulujemy 20000 scenariuszy rocznych strat. Do każdej symulacji wylosowano liczbę zdarzeń z rozkładu dwumianowego oraz straty dla każdej szkody z rozkładu wykładniczego.

```{r}
n_sim <- 20000
size_param_binom2 <- 100

symulacje_Damage <- replicate(n_sim, {
  liczba_zdarzen <- rbinom(1, size = size_param_binom2, prob = prob_param2)
  if (liczba_zdarzen == 0) return(0)
  sum(rexp(liczba_zdarzen, rate = rate2))
})
```

Następnie na podstawie rozkładu symulowanego obliczamy OpVaR(99.9%) oraz OpES(99.9%).

```{r}
OpVaR_999_Damage <- quantile(symulacje_Damage, 0.999)
OpES_999_Damage <- mean(symulacje_Damage[symulacje_Damage > OpVaR_999_Damage])

hist_Damage <- hist(symulacje_Damage, breaks = 100, col = "lightblue",
     main = "Symulowany rozkład strat rocznych (Damage)",
     xlab = "Suma strat")
abline(v = OpVaR_999_Damage, col = "red", lwd = 2, lty = 2)

cat("OpVaR (99.9%) = ", OpVaR_999_Damage, "\n")
cat("OpES  (99.9%) = ", OpES_999_Damage, "\n")

```

Histogram symulowanego rozkładu strat, a na nim zaznaczona jest wartość OpVaR. Na osi X mamy wielkość straty, a na osi Y częstotliwość tych strat. Większość strat wynosi ok. 1500000. Widzimy, że wykres dalej jest prawoskośny, choć znacznie bardziej symetryczny niż dla dwóch poprzednich linii. Średnia dotkliwość jak i ich częstotliwość również jest większa.

# linia Empl_Pract

## Rozkład częstotliwości

```{r}
rok_Empl_Pract <- plik28 |>
  filter( linia == "Empl_Pract") |>
  group_by(rok) |>
  summarize(liczba_zdarzen = n())

straty_Empl_Pract <- plik28 |>
  filter(linia == "Empl_Pract") |>
  group_by(rok) |>
  summarize(straty = sum(strata, na.rm = TRUE))



Damage_summary <- merge(rok_Empl_Pract, straty_Empl_Pract, by = "rok")

kable(Damage_summary, format = "html", caption = "Podsumowanie dla liniii Empl_Pract") |> 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

```

Dane zostały przefiltrowane dla liniii Empl_Pract Dla każdego roku obliczono liczbę zdarzeń oraz sumę strat.

```{r}
mean_Empl_Pract = mean(rok_Empl_Pract$liczba_zdarzen)
sd_Empl_Pract = sd(rok_Empl_Pract$liczba_zdarzen)

mean_Empl_Pract
sd_Empl_Pract
```

Średnia liczba zdarzeń to 213.54 a odchylenie standardowe 20.07. Na tej podstawie dopasowujemy rozkład ujemny dwumianowy, ponieważ gdy E(X) \< D\^2(X).

## Rozkład zdarzeń

Przyporządkowaliśmy rozkład ujemny dwumianowy. Dla pewności, sprawdźmy jeszcze dopasowanie funkcją "fitdistr":

```{r}
Empl_Pract_fit <- fitdist(rok_Empl_Pract$liczba_zdarzen, "nbinom")
gofstat(Empl_Pract_fit)
```

p-value wynosi 0,82 z tego powodu nie ma podstaw do odrzucenia hipotezy zerowej i możemy uznać rozkład ujemny dwumianowy za dobrze dopasowany. Dla pewności zobaczymy to jeszcze na wykresie:

```{r}
plot(Empl_Pract_fit)
```

Dobrze przyjrzeć się w tym przypadku na wykres dystrybuanty. Widzimy, że dopasowanie jest nie najgorsze, rozjeżdża się przy ogonach, a zwłaszcza tym z prawej, ale w środku jest bardzo dobre.

## Rozkład strat

Będziemy sprawdzać dopasowanie funkcją fitdist, sprawdzamy dopasowanie rozkładu dotkliwości strat do rozkładów weibull, lnorm, exp oraz gamma. Dopasowanie metodą momentów (mme).

```{r}
Empl_Pract <- fitdist(straty_Empl_Pract$straty,"weibull")
Empl_Pract2 <- fitdist(straty_Empl_Pract$straty, method="mme","lnorm")
Empl_Pract3 <- fitdist(straty_Empl_Pract$straty, method="mme","exp")
Empl_Pract4 <- fitdist(straty_Empl_Pract$straty, method="mme","gamma")
names_test = c("weibull","lnorm", "exp", "gamma")

Result_Empl_Pract<-gofstat(list(Empl_Pract,Empl_Pract2, Empl_Pract3, Empl_Pract4), fitnames=names_test)
Result_Empl_Pract$chisqpvalue
Result_Empl_Pract$adtest
Result_Damage$kstest
```

Żaden test nie odrzuca dopasowania. Z tego powodu zobaczmy to na wykresie.

-   Dla lnorm:

```{r}
plot(fitdist(straty_Empl_Pract$straty, "lnorm"))

```

-   Dla gammy:

```{r}
plot(fitdist(straty_Empl_Pract$straty, "gamma"))
```

-   Dla weibulla:

```{r}
plot(fitdist(straty_Empl_Pract$straty, "weibull"))
```

-   Dla exp:

```{r}
plot(fitdist(straty_Empl_Pract$straty, "exp"))
```

Na wykresie możemy zobaczyć, że rozkład teoretyczny gamma jest nieco lepiej dopasowany, decydujemy się na wybór **gamma**.

## Symulacja

Symulacja metodą Monte Carlo bazująca na dwóch wcześniej wybranych rozkładach - ujemnym dwumianowy oraz gamma.

```{r}
nbinom_params3 <- Empl_Pract_fit$estimate 
size_param3 <- nbinom_params3["size"]
mu_param3 <- nbinom_params3["mu"]

gamma_params3 <- Empl_Pract4$estimate
shape_param3 <- gamma_params3["shape"]
rate_param3 <- gamma_params3["rate"]
```

Parametry dla rozkładu ujemno-dwumianowgo: <br> size = 255.11<br> mu = 213.54<br>

Parametry dopasowania gamma:<br> shape = 1.092585e+02<br> rate = 1.461848e-05<br>

<br> <br>

Symulujemy 20000 scenariuszy rocznych strat. Do każdej symulacji wylosowano liczbę zdarzeń z rozkładu ujemnego-dwumianowego oraz straty dla każdej szkody z rozkładu gamma.

```{r}
n_sim <- 20000 

symulacje_Empl_Pract <- replicate(n_sim, {
  liczba_zdarzen <- rnbinom(1, size = size_param3, mu = mu_param3)
  if (liczba_zdarzen == 0) return(0)
  sum(rgamma(liczba_zdarzen, shape = shape_param3, rate = rate_param3))
})
```

Następnie na podstawie rozkładu symulowanego obliczamy OpVaR(99.9%) oraz OpES(99.9%).

```{r}
OpVaR_999_Empl_Pract <- quantile(symulacje_Empl_Pract, 0.999)
OpES_999_Empl_Pract <- mean(symulacje_Empl_Pract[symulacje_Empl_Pract > OpVaR_999_Empl_Pract])

hist_Empl_Pract <- hist(symulacje_Empl_Pract, breaks = 100, col = "lightblue",
     main = "Symulowany rozkład strat rocznych (Empl_Pract)",
     xlab = "Suma strat")
abline(v = OpVaR_999_Empl_Pract, col = "red", lwd = 2, lty = 2)

# Wyniki
cat("OpVaR (99.9%) = ", OpVaR_999_Empl_Pract, "\n")
cat("OpES  (99.9%) = ", OpES_999_Empl_Pract, "\n")

```

Histogram symulowanego rozkładu strat, a na nim zaznaczona jest wartość OpVaR. Na osi X mamy wielkość straty, a na osi Y częstotliwość tych strat. Większość strat wynosi ok. 1.6e+09. Rozkład jest bardzo zbliżony do normalnego oraz posiada największe do tej pory wielkości strat zachowujac umiarkowaną częstotliwość ich występowania co do roku.

# linia Execut_Del

## Rozkład częstotliwości

```{r}
rok_Execut_Del <- plik28 |>
  filter( linia == "Execut_Del") |>
  group_by(rok) |>
  summarize(liczba_zdarzen = n())

straty_Execut_Del <- plik28 |>
  filter(linia == "Execut_Del") |>
  group_by(rok) |>
  summarize(straty = sum(strata, na.rm = TRUE))

Exe_summary <- merge(rok_Execut_Del, straty_Execut_Del, by = "rok")

kable(Exe_summary, format = "html", caption = "Podsumowanie dla liniii Execut_Del") |> 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

```

Dane zostały przefiltrowane dla liniii Execut_Del. Dla każdego roku obliczono liczbę zdarzeń oraz sumę strat.

```{r}

mean_Execut_Del = mean(rok_Execut_Del$liczba_zdarzen)
sd_Execut_Del = sd(rok_Execut_Del$liczba_zdarzen)

mean_Execut_Del
sd_Execut_Del
```

Średnia liczba zdarzeń to 7.11 a odchylenie standardowe 2.28. Na tej podstawie dopasowujemy rozkład dwumianowy, ponieważ gdy E(X) \> D\^2(X).

## Rozkład zdarzeń

Przyporządkowaliśmy rozkład dwumianowy. Dla pewności, sprawdźmy jeszcze dopasowanie funkcją "fitdistr":

```{r}
Execut_Del_fit <- fitdist(rok_Execut_Del$liczba_zdarzen, "binom",fix.arg = list(size = size_value))
gofstat(Execut_Del_fit)
```

p-value wynosi 0,64 z tego powodu nie ma podstaw do odrzucenia hipotezy zerowej i możemy uznać rozkład dwumianowy za dobrze dopasowany. Dla pewności zobaczymy to jeszcze na wykresie:

```{r}
plot(Execut_Del_fit)
```

Rozkład wydaje się być dobrze dopasowany, gęstość rozkładu empirycznego wydaje się dla każdej wartości nieco większa, wyjątkiem jest punkt 5, któy nie występuje dla naszych danych. Tak czy inaczej rozkład binom wydaje się sensowny.

## Rozkład strat

Będziemy sprawdzać dopasowanie funkcją fitdist, sprawdzamy dopasowanie rozkładu dotkliwości strat do rozkładów weibull, lnorm, exp oraz gamma. Dopasowanie metodą momentów (mme).

```{r}
Execut_Del1 <- fitdist(straty_Execut_Del$straty, "weibull")
Execut_Del2 <- fitdist(straty_Execut_Del$straty, method="mme","lnorm")
Execut_Del3 <- fitdist(straty_Execut_Del$straty, method="mme","exp")
Execut_Del4 <- fitdist(straty_Execut_Del$straty, method="mme","gamma")
names_test = c("Weibull","lnorm", "exp", "gamma")

Result_Execut_Del<-gofstat(list(Execut_Del1, Execut_Del2,Execut_Del3,Execut_Del4), fitnames=names_test)
Result_Execut_Del$chisqpvalue
Result_Execut_Del$adtest
Result_Execut_Del$kstest
```

Tylko w przypadku kstest exp zostało odrzucone, reszta nieodrzucona. Z tego powodu zobaczmy to na wykresie.

-   Dla weibull:

```{r}
plot(fitdist(straty_Execut_Del$straty, "weibull"))

```

-   Dla gammy:

```{r}
plot(fitdist(straty_Execut_Del$straty, "gamma"))
```

Wybieramy dopasowanie do rozkładu weibulla.

## Symulacja

Symulacja metodą Monte Carlo bazująca na dwóch wcześniej wybranych rozkładach - ujemnym dwumianowy oraz gamma.

```{r}
set.seed(123)

binom_params_exec <- Execut_Del_fit$estimate
prob_param_exec <- binom_params_exec["prob"]


weibull_params_exec <- Execut_Del1$estimate
shape_exec <- weibull_params_exec["shape"]
scale_exec <- weibull_params_exec["scale"]

```

Parametry dla rozkładu dwumianowego: <br> prob = 0.71<br>

Parametry dopasowania weibulla:<br> shape = 1.95<br> scale = 42473.57<br>

<br> <br>

Symulujemy 20000 scenariuszy rocznych strat. Do każdej symulacji wylosowano liczbę zdarzeń z rozkładu dwumianowego oraz straty dla każdej szkody z rozkładu weibulla.

```{r}
n_sim <- 20000
size_param_binom <- 100

symulacje_Execut_Del <- replicate(n_sim, {
  liczba_zdarzen <- rbinom(1, size = size_param_binom, prob = prob_param_exec)
  if (liczba_zdarzen == 0) return(0)
  sum(rweibull(liczba_zdarzen, shape = shape_exec, scale = scale_exec))
})
```

Następnie na podstawie rozkładu symulowanego obliczamy OpVaR(99.9%) oraz OpES(99.9%).

```{r}
OpVaR_999_Execut_Del <- quantile(symulacje_Execut_Del, 0.999)
OpES_999_Execut_Del <- mean(symulacje_Execut_Del[symulacje_Execut_Del > OpVaR_999_Execut_Del])

hist_Execut_Del <- hist(symulacje_Execut_Del, breaks = 100, col = "lightblue",
     main = "Symulowany rozkład strat (Execut_Del)", xlab = "Suma strat")
abline(v = OpVaR_999_Execut_Del, col = "red", lwd = 2, lty = 2)

cat("OpVaR (99.9%) = ", OpVaR_999_Execut_Del, "\n")
cat("OpES  (99.9%) = ", OpES_999_Execut_Del, "\n")

```

Histogram symulowanego rozkładu strat, a na nim zaznaczona jest wartość OpVaR. Na osi X mamy wielkość straty, a na osi Y częstotliwość tych strat. Większość strat wynosi ok. 2e+05.Rozkład jest znacznie prawoskośny. Straty są umiarkowanie dotkliwe.

# linia External_Fr

## Rozkład częstotliwości

```{r}
rok_External_Fr <- plik28 |>
  filter( linia == "External_Fr") |>
  group_by(rok) |>
  summarize(liczba_zdarzen = n())


straty_External_Fr <- plik28 |>
  filter(linia == "External_Fr") |>
  group_by(rok) |>
  summarize(straty = sum(strata, na.rm = TRUE))


Ext_summary <- merge(rok_External_Fr, straty_External_Fr, by = "rok")

kable(Ext_summary, format = "html", caption = "Podsumowanie dla liniii External_Fr") |> 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

```

Dane zostały przefiltrowane dla liniii Execut_Del. Dla każdego roku obliczono liczbę zdarzeń oraz sumę strat.

```{r}

mean_External_Fr = mean(rok_External_Fr$liczba_zdarzen)
sd_External_Fr = sd(rok_External_Fr$liczba_zdarzen)
mean_External_Fr
sd_External_Fr

```

Średnia liczba zdarzeń to 11.2 a odchylenie standardowe 2.37. Na tej podstawie dopasowujemy rozkład dwumianowy, ponieważ gdy E(X) \> D\^2(X).

## Rozkład zdarzeń

Przyporządkowaliśmy rozkład dwumianowy. Dla pewności, sprawdźmy jeszcze dopasowanie funkcją "fitdistr":

```{r}
External_Fr_fit <- fitdist(rok_External_Fr$liczba_zdarzen, "binom",fix.arg = list(size = size_value))
gofstat(External_Fr_fit)

```

p-value wynosi 0,08 z tego powodu nie ma podstaw do odrzucenia hipotezy zerowej i możemy uznać rozkład dwumianowy za dobrze dopasowany. Dla pewności zobaczymy to jeszcze na wykresie:

```{r}
plot(External_Fr_fit)
```

Po stosunkowo niskim p-value możnaby było spodziewać się sporych różnic między rozkładem empirycznym a teoretycznym. Jednak z braku lepszych opcji wybierzemy właśnie jego.

## Rozkład strat

Będziemy sprawdzać dopasowanie funkcją fitdist, sprawdzamy dopasowanie rozkładu dotkliwości strat do rozkładów weibull, lnorm, exp oraz gamma. Dopasowanie metodą momentów (mme).

```{r}
External_Fr1 <- fitdist(straty_External_Fr$straty, "weibull")
External_Fr2 <- fitdist(straty_External_Fr$straty, method="mme","lnorm")
External_Fr3 <- fitdist(straty_External_Fr$straty, method="mme","exp")
External_Fr4 <- fitdist(straty_External_Fr$straty, method="mme","gamma")
names_test = c("Weibull","lnorm", "exp", "gamma")

Result_External_Fr<-gofstat(list(External_Fr1, External_Fr2,External_Fr3,External_Fr4), fitnames=names_test)
Result_External_Fr$chisqpvalue
Result_External_Fr$adtest
Result_External_Fr$kstest

```

Tylko w przypadku kstest exp zostało odrzucone, reszta nieodrzucona. Z tego powodu zobaczmy to na wykresie.

-   Dla lnorm:

```{r}
plot(fitdist(straty_External_Fr$straty, "lnorm"))

```

-   Dla gammy:

```{r}
plot(fitdist(straty_External_Fr$straty, "gamma"))

```

Wybieramy dopasowanie do rozkładu Lnorm.

## Symulacja

Symulacja metodą Monte Carlo bazująca na dwóch wcześniej wybranych rozkładach - dwumianowy oraz Lnorm.

```{r}
set.seed(123)

binom_params_ext <- External_Fr_fit$estimate
prob_param_ext <- binom_params_ext["prob"]

lnorm_params_ext <- External_Fr2$estimate
meanlog_ext <- lnorm_params_ext["meanlog"]
sdlog_ext <- lnorm_params_ext["sdlog"]


```

Parametry dla rozkładu dwumianowego: <br> prob = 0.11<br>

Parametry dopasowania Lnorm:<br> meanlog = 10.37<br> sdlog = 0.43<br>

<br> <br>

Symulujemy 20000 scenariuszy rocznych strat. Do każdej symulacji wylosowano liczbę zdarzeń z rozkładu dwumianowego oraz straty dla każdej szkody z rozkładu Lnorm.

```{r}
symulacje_External_Fr <- replicate(n_sim, {
  liczba_zdarzen <- rbinom(1, size = size_param_binom, prob = prob_param_ext)
  if (liczba_zdarzen == 0) return(0)
  sum(rlnorm(liczba_zdarzen, meanlog = meanlog_ext, sdlog = sdlog_ext))
})


```

Następnie na podstawie rozkładu symulowanego obliczamy OpVaR(99.9%) oraz OpES(99.9%).

```{r}
OpVaR_999_External_Fr <- quantile(symulacje_External_Fr, 0.999)
OpES_999_External_Fr <- mean(symulacje_External_Fr[symulacje_External_Fr > OpVaR_999_External_Fr])

hist_External_Fr <- hist(symulacje_External_Fr, breaks = 100, col = "lightblue",
     main = "Symulowany rozkład strat (External_Fr)", xlab = "Suma strat")
abline(v = OpVaR_999_External_Fr, col = "red", lwd = 2, lty = 2)

cat("OpVaR (99.9%) = ", OpVaR_999_External_Fr, "\n")
cat("OpES  (99.9%) = ", OpES_999_External_Fr, "\n")

```

Histogram symulowanego rozkładu strat, a na nim zaznaczona jest wartość OpVaR. Na osi X mamy wielkość straty, a na osi Y częstotliwość tych strat. Większość strat wynosi ok. 350000. Wykres jest lekko prawoskośny.

# linia Internal_Fr

## Rozkład częstotliwości

```{r}
rok_Internal_Fr <- plik28 |>
  filter( linia == "Internal_Fr") |>
  group_by(rok) |>
  summarize(liczba_zdarzen = n())

straty_Internal_Fr <- plik28 |>
  filter(linia == "Internal_Fr") |>
  group_by(rok) |>
  summarize(straty = sum(strata, na.rm = TRUE))



Int_summary <- merge(rok_Internal_Fr, straty_Internal_Fr, by = "rok")

kable(Int_summary, format = "html", caption = "Podsumowanie dla liniii Internal_Fr") |> 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

```

Dane zostały przefiltrowane dla liniii Execut_Del. Dla każdego roku obliczono liczbę zdarzeń oraz sumę strat.

```{r}

mean_Internal_Fr = mean(rok_Internal_Fr$liczba_zdarzen)
sd_Internal_Fr = sd(rok_Internal_Fr$liczba_zdarzen)
mean_Internal_Fr
sd_Internal_Fr

```

Średnia liczba zdarzeń to 187.6 a odchylenie standardowe 21.9. Na tej podstawie dopasowujemy rozkład ujemny dwumianowy, ponieważ gdy E(X) \< D\^2(X).

## Rozkład zdarzeń

Przyporządkowaliśmy rozkład ujemny dwumianowy. Dla pewności, sprawdźmy jeszcze dopasowanie funkcją "fitdistr":

```{r}
Internal_Fr_fit <- fitdist(rok_Internal_Fr$liczba_zdarzen, "nbinom")
gofstat(Internal_Fr_fit)

```

p-value wynosi 0.16 z tego powodu nie ma podstaw do odrzucenia hipotezy zerowej i możemy uznać rozkład ujemny dwumianowy za dobrze dopasowany. Dla pewności zobaczymy to jeszcze na wykresie:

```{r}
plot(Internal_Fr_fit)
```

Ponowie kierując spojrzenie na rozkład dystrybuanty można uznać, że rozkład został w tym przypadku zdecydowanie dobrze przyporządkowany.

## Rozkład strat

Będziemy sprawdzać dopasowanie funkcją fitdist, sprawdzamy dopasowanie rozkładu dotkliwości strat do rozkładów lnorm, exp oraz gamma. Dopasowanie metodą momentów (mme).

```{r}
Internal_Fr2 <- fitdist(straty_Internal_Fr$straty, method="mme","lnorm")
Internal_Fr3 <- fitdist(straty_Internal_Fr$straty, method="mme","exp")
Internal_Fr4 <- fitdist(straty_Internal_Fr$straty, method="mme","gamma")
names_test = c("lnorm", "exp", "gamma")

Result_Internal_Fr<-gofstat(list(Internal_Fr2, Internal_Fr3,Internal_Fr4), fitnames=names_test)
Result_Internal_Fr$chisqpvalue
Result_Internal_Fr$adtest
Result_Internal_Fr$kstest


```

Tylko w przypadku kstest exp zostało odrzucone, reszta nieodrzucona. Z tego powodu zobaczmy to na wykresie.

-   Dla lnorm:

```{r}
plot(fitdist(straty_Internal_Fr$straty, "lnorm"))

```

-   Dla gammy:

```{r}

plot(fitdist(straty_Internal_Fr$straty, "gamma"))

```

Wybieramy dopasowanie do rozkładu Lnorm.

## Symulacja

Symulacja metodą Monte Carlo bazująca na dwóch wcześniej wybranych rozkładach - ujemny dwumianowy oraz Lnorm.

```{r}
set.seed(123)

# Parametry nbinom
nbinom_params_int <- Internal_Fr_fit$estimate
size_param_int <- nbinom_params_int["size"]
mu_param_int <- nbinom_params_int["mu"]

# Parametry log-normal
lnorm_params_int <- Internal_Fr2$estimate
meanlog_int <- lnorm_params_int["meanlog"]
sdlog_int <- lnorm_params_int["sdlog"]


```

Parametry dla rozkładu ujemnego dwumianowego: <br> size = 127.88<br> mu = 187.59<br>

Parametry dopasowania Lnorm:<br> meanlog = 13.75<br> sdlog = 0.15<br>

<br> <br>

Symulujemy 20000 scenariuszy rocznych strat. Do każdej symulacji wylosowano liczbę zdarzeń z rozkładu ujemnego dwumianowego oraz straty dla każdej szkody z rozkładu Lnorm.

```{r}
symulacje_Internal_Fr <- replicate(n_sim, {
  liczba_zdarzen <- rnbinom(1, size = size_param_int, mu = mu_param_int)
  if (liczba_zdarzen == 0) return(0)
  sum(rlnorm(liczba_zdarzen, meanlog = meanlog_int, sdlog = sdlog_int))
})


```

Następnie na podstawie rozkładu symulowanego obliczamy OpVaR(99.9%) oraz OpES(99.9%).

```{r}
OpVaR_999_Internal_Fr <- quantile(symulacje_Internal_Fr, 0.999)
OpES_999_Internal_Fr <- mean(symulacje_Internal_Fr[symulacje_Internal_Fr > OpVaR_999_Internal_Fr])

hist_Internal_Fr <- hist(symulacje_Internal_Fr, breaks = 100, col = "lightblue",
     main = "Symulowany rozkład strat (Internal_Fr)", xlab = "Suma strat")
abline(v = OpVaR_999_Internal_Fr, col = "red", lwd = 2, lty = 2)

cat("OpVaR (99.9%) = ", OpVaR_999_Internal_Fr, "\n")
cat("OpES  (99.9%) = ", OpES_999_Internal_Fr, "\n")


```

Histogram symulowanego rozkładu strat, a na nim zaznaczona jest wartość OpVaR. Na osi X mamy wielkość straty, a na osi Y częstotliwość tych strat. Większość strat wynosi ok. 17000000. Rozkład jest symetyczny, jest lekko "wyższy", niż normalny.

# Podsumowanie

```{r}
## tabelka podsumowująca:
symulacje_df <- data.frame(
  Scenariusz = 1:n_sim,
  BussDist = symulacje_BussDist,
  Com_Ban = symulacje_Com_Ban,
  Damage = symulacje_Damage,
  Empl_Pract = symulacje_Empl_Pract,
  Execut_Del = symulacje_Execut_Del,
  External_Fr = symulacje_External_Fr,
  Internal_Fr = symulacje_Internal_Fr
)

# Dodanie kolumny z sumą strat dla każdego scenariusza
symulacje_df$Suma <- rowSums(symulacje_df[, -1])

# Podgląd

kable(head(symulacje_df,20), caption = "Tabela 1: Wielkość strat w kontekście scenariuszy:", 
      align = "lrr", format = "markdown")

```

Dzięki temu zestawieniu możemy zobaczyć, jak w konkretnym scenariuszu będzie wyglądała suma opVaru 999.

```{r}
library(tibble)
library(dplyr)

# Tabela ze wskaźnikami
tabela_oprisk <- tibble(
  linia_Biznesowa = c("Business Disruption", "Commercial Banking", "Damage to Assets", 
                      "Employment Practices", "Execution & Delivery", 
                      "External Fraud", "Internal Fraud"),
  OpVaR_999 = c(OpVaR_999_BussDist, OpVaR_999_Com_Ban, OpVaR_999_Damage,
                OpVaR_999_Empl_Pract, OpVaR_999_Execut_Del,
                OpVaR_999_External_Fr, OpVaR_999_Internal_Fr),
  OpES_999 = c(OpES_999_BussDist, OpES_999_Com_Ban, OpES_999_Damage,
               OpES_999_Empl_Pract, OpES_999_Execut_Del,
               OpES_999_External_Fr, OpES_999_Internal_Fr)
) %>%
  mutate(across(OpVaR_999:OpES_999, round, 2))


# Wyświetlenie tabeli
library(knitr)

kable(tabela_oprisk, caption = "Tabela 2: Wskaźniki OpVaR i OpES dla poszczególnych liniii biznesowych", 
      align = "lrr", format = "markdown")

```

Tabela zestawia Var 99 oraz stratę dla każdej z 7 linii biznesowych. Widzimy zdecydowanie najwyższe wartości dla Employment Practises. Prawdopodobnie chodzi tu o możliwe naruszenia praw przez pracowników. Dla banków jest to szczególnie dotkliwe ryzyko, ponieważ może skutkować oszustwami i próbami wyłudzania np. kredytu co może być opłakane w skutkach dla danego banku.

Najniższą stratę posiada Execution & Delivery. Problemy związane z dostawą choć mogą być kosztowne jak widzimy są najmniejszym zmartwieniem dla banków.

Porównując wartości dla OpVaru 999 widzimy jak z wielkim ryzykiem straty wiąże się praca banków. Powinny mieć one ogromne poduszki finansowe lub jakieś innego typu zabezpieczenia, które pomogły by w przypadku nasilenia się problemów.

Zobaczmy jeszcze razem na rozkłady wynikó symulacji dla każdej z linii. Można zauważyć, że większość z nich jest zdecydowanei prawo-skośna. Nieliczne z nich są trochę bardziej scentrowane.

```{r}
library(gridExtra)

par(mfrow = c(3, 3), mar = c(4, 4, 2, 1))
plot(hist_BussDist)
plot(hist_Com_Ban)
plot(hist_Damage)
plot(hist_Empl_Pract)
plot(hist_Execut_Del)
plot(hist_External_Fr)
plot(hist_Internal_Fr)
```

**Wnioski**

Zróżnicowane ryzyko w liniach biznesowych: Wysokie wartości VaR 99 i strat w Employment Practices wskazują na znaczące ryzyko prawne związane z działaniami pracowników. Choć inne liniie, takie jak Execution & Delivery, pokazują mniejsze straty, to nie oznacza to, że nie wiążą się z żadnym ryzykiem. Problem dostaw może mieć wpływ na reputację i koszty operacyjne, ale nie jest równie groźny jak ryzyko oszustw w bankowości.

Zabezpieczenia finansowe w bankach: Analiza VaR 99 pokazuje, że banki powinny posiadać solidne zabezpieczenia finansowe, aby radzić sobie z potencjalnymi stratami. Wysokie ryzyko w liniach związanych z bankowością wymaga odpowiednich mechanizmów ochrony przed takimi zdarzeniami.

Niejednorodność rozkładów strat: Większość rozkładów strat wykazuje charakter prawoskośny, co może sugerować, że większość strat jest stosunkowo niewielka, ale niektóre incydenty mogą powodować wyjątkowo duże straty. To podkreśla, jak istotne jest monitorowanie i modelowanie ryzyka skrajnych zdarzeń.
