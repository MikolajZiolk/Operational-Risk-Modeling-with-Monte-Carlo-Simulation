---
title: "Zad3_RyzykoOperacyjny"
author: "Mikoaj Zi贸kowski, Tomasz Saapatek"
date: today
editor: visual
format: 
  html:
    toc: true
    toc-depth: 3
    toc-location: left
    toc-title: Spis Treci
    number-sections: true
    number-depth: 3
    embed-resources: true
    html-math-method: katex
    code-tools: true
    code-block-bg: true
    code-fold: true
    code-summary: "Show and hide code"
    link-external-icon: true
    link-external-newwindow: true
    smooth-scroll: true
    self-contained: true
    fontsize: 1.0em
    linestretch: 1.3
    fig-align: center
execute: 
  echo: true
  error: false
  warning: false
  output: true
editor_options: 
  chunk_output_type: console
---

<style type="text/css"> body {text-align: justify} </style>

# Wstp

## Dane

Pocztkowo adujemy potrzebne biblioteki, takie jak:

\- distr

\- tidyr

\- dplyr

\- MASS

\- fitdistrplus

\- knitr

\- kableExtra

<br> Nastpnie pobieramy dane dotyczce wysokoci strat brutto dla wybranego okresu oraz kategorii ryzyka. Dane zawieraj kolumny takie jak rok, strata, linia. W kolumnie linia znajduje si 7 linii biznesowych: BussDistr, Com_Ban, Damage Empl_Pract, Execut_Del, External_Fr, Internal_Fr. <br> Poni偶ej 6 pierwszych rekord贸w:

```{r}
library(distr)
library(tidyr)
library(dplyr)
library(MASS)
library(fitdistrplus)
library(knitr)
library(kableExtra)

plik28 <- read.csv("C:/Users/mikol/OneDrive/Desktop/Modelowanie Ryzyka KiU/zad3/plik28.csv", sep=";")


plik28 <- plik28 |> 
  mutate(strata = as.numeric(strata))

head(plik28)

```

# linia Buss_Distr

## Rozkad czstotliwoci

Mowa tu o czstotliwoci z kt贸r dana kategoria ryzyka wystpowaa na przestrzeni roku. Bdziemy starali si bazie danych historycznych przyporzdkowa tym danym najbardziej odpowiadajcy im model. W taki spos贸b, aby m贸c w przyszoci przeprowadzi symulacj.

W przyporzdkowaniu rozkad贸w sugerowalimy si zasad przytoczon na wykadzie, mianowicie: <br> - EX \>2 rozkad dwumianowy <br> - E =2 rozkad Poissona <br> - E \<2 rozkad ujemny dwumianowy <br>

```{r}
rok_BussDistr <- plik28 %>%
  filter( linia == "Buss_Distr") %>%
  group_by(rok) %>%
  summarize(liczba_zdarzen = n())

straty_BussDistr <- plik28 %>%
  filter(linia == "Buss_Distr") %>%
  group_by(rok) %>%
  summarize(straty = sum(strata, na.rm = TRUE))

BussDistr_summary <- merge(rok_BussDistr, straty_BussDistr, by = "rok")

kable(BussDistr_summary, format = "html", caption = "Podsumowanie dla liniii Buss_Distr") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)


```

Rozkady czstotliwoci w zale偶noci od roku oraz strat w zale偶noci od linii biznesowych. Filtrujemy dane tylko do Buss_Distr. DLa tej linii liczymy liczb zdarze operacyjnych w ka偶dym roku oraz sum strat rocznych.

```{r}
mean_BussDistr = mean(rok_BussDistr$liczba_zdarzen)
sd_BussDistr = sd(rok_BussDistr$liczba_zdarzen)

mean_BussDistr
sd_BussDistr
```

## Rozkad zdarze

rednia i odchylenie standardowe wynosz kolejno: 10,657 oraz 4,485. Zgodnie z zasad przytoczon wczeniej przyporzdkowalimy temu rozkad ujemny dwumianowy. Dla pewnoci, sprawd藕my jeszcze dopasowanie funkcj "fitdistr":

```{r}
BussDistr_fit <- fitdist(rok_BussDistr$liczba_zdarzen, "nbinom")
gofstat(BussDistr_fit)
```

p-value wynosi 0,208 z tego powodu nie ma podstaw do odrzucenia hipotezy i mo偶emy uzna rozkad ujemny dwumianowy za dobrze dopasowany. Dla pewnoci zobaczymy to jeszcze na wykresie:

```{r}
plot(fitdist(rok_BussDistr$liczba_zdarzen, "nbinom"))
```

Dopasowanie zdecydowanie nie jest idealne. Wartoci empiryczne rozje偶d偶aj si z teoretycznymi zwaszcza na rodku.

## Rozkad strat

Ponownie, sprawd藕my dopasowanie funkcj fitdist, tym razem sprawdzamy dopasowanie rozkadu dotkliwoci strat do rozkad贸w lnorm, exp oraz gamma. Dopasowanie metod moment贸w (mme)

```{r}
BussDistr2 <- fitdist(straty_BussDistr$straty, method="mme","lnorm")
BussDistr3 <- fitdist(straty_BussDistr$straty, method="mme","exp")
BussDistr4 <- fitdist(straty_BussDistr$straty, method="mme","gamma")
names_test = c("lnorm", "exp", "gamma")

Result_BussDist<-gofstat(list(BussDistr2, BussDistr3, BussDistr4), fitnames=names_test)
Result_BussDist$chisqpvalue
Result_BussDist$adtest
Result_BussDist$kstest
```

Zar贸wno rozkad lnorm jak i gamma m贸gby by dobrym kandydatem. Z tego powodu, zobaczmy to na wykresie.

-   Dla gammy:

```{r}
plot(fitdist(straty_BussDistr$straty, "gamma"))
```

-   Dla lnorm:

```{r}
plot(fitdist(straty_BussDistr$straty, "lnorm"))

```

Na wykresie mo偶emy zobaczy, 偶e rozkad teoretyczny **lnorm**, nieco lepiej odzwerciedla rozkad naszyh danych, wic to jego wybierzemy do dalszych bada.

## Symulacja

Przeprowadzilimy symulacj metod Monte Carlo bazujc na dw贸ch wczeniej wybranych rozkadach - dwumianowy ujemny oraz logarytmiczno - normalny.

```{r}
set.seed(123)

nbinom_params <- BussDistr_fit$estimate 
size_param <- nbinom_params["size"]
mu_param <- nbinom_params["mu"]

lnorm_params <- BussDistr2$estimate
meanlog <- lnorm_params["meanlog"]
sdlog <- lnorm_params["sdlog"]

```

Parametry dopasowane metod maksymalnej wiarygodnoci dla rozkadu ujemnego dwumianowego: <br> size = 12.23<br> mu = 10.66<br>

Parametry dopasowania log-norm:<br> meanlog = 13.08<br> sdlog = 0.40<br> <br> <br>

W pierwszej kolejnoci symulujemy 20000 scenariuszy rocznych strat. Losujemy liczb zdarze z rozkadu ujemnego dwumianowego. Dla ka偶dej liczby zdarze losujemy odpowiedni liczb strat z rozkadu log-normalnego. Sumujemy je = to jedna realizacja rocznej straty.

```{r}
n_sim <- 20000 

symulacje_BussDist <- replicate(n_sim, {
  liczba_zdarzen <- rnbinom(1, size = size_param, mu = mu_param)
  if (liczba_zdarzen == 0) return(0)
  sum(rlnorm(liczba_zdarzen, meanlog = meanlog, sdlog = sdlog))
})

```

Nastpnie na podstawie rozkadu symulowanego obliczamy OpVaR(99.9%) oraz OpES(99.9%).

```{r}
OpVaR_999_BussDist <- quantile(symulacje_BussDist, 0.999)
OpES_999_BussDist <- mean(symulacje_BussDist[symulacje_BussDist > OpVaR_999_BussDist])

#histogramu rozkadu symulowanych strat:
hist_BussDist <-hist(symulacje_BussDist, breaks = 100, col = "lightblue", main = "Symulowany rozkad strat rocznych", xlab = "Suma strat")
abline(v = OpVaR_999_BussDist, col = "red", lwd = 2, lty = 2)


cat("OpVaR (99.9%) =", OpVaR_999_BussDist, "\n")
cat("OpES  (99.9%) =", OpVaR_999_BussDist, "\n")

```

Na podstawie symulacji sporzdzilimy histogram symulowanego rozkadu strat, a na nim zaznaczona jest warto OpVaR. Na osi X mamy wielko straty, a na osi Y czstotliwo tych strat. Widzimy, 偶e rozkad jest mocno prawoskony z dugimi ogonami. Wikszo strat wynosi ok. 5000000.

# linia Com_Ban

## Rozkad czstotliwoci

```{r}
rok_Com_Ban <- plik28 |>
  filter( linia == "Com_Ban") |>
  group_by(rok) |>
  summarize(liczba_zdarzen = n())

straty_Com_Ban <- plik28 |>
  filter(linia == "Com_Ban") |>
  group_by(rok) |>
  summarize(straty = sum(strata, na.rm = TRUE))

Com_Ban_summary <- merge(rok_Com_Ban, straty_Com_Ban, by = "rok")

kable(Com_Ban_summary, format = "html", caption = "Podsumowanie dla liniii Com_Ban") |> 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

```

Pocztkowo dane zostay przefiltrowane dla liniii Com_Ban. Dla ka偶dego roku obliczono liczb zdarze oraz sum strat.

```{r}
mean_Com_Ban = mean(rok_Com_Ban$liczba_zdarzen)
sd_Com_Ban = sd(rok_Com_Ban$liczba_zdarzen)

mean_Com_Ban
sd_Com_Ban
```

rednia liczba zdarze to 6.2 a odchylenie standardowe 2.08. Na tej podstawie dopasowujemy rozkad dwumianowy, poniewa偶 gdy E(X) \> D\^2(X) to ta cecha wskazuje na ta taki rozkad.

## Rozkad zdarze

Przyporzdkowalimy rozkad dwumianowy, z parametrem size=100. Dla pewnoci, sprawd藕my jeszcze dopasowanie funkcj "fitdistr":

```{r}
size_value <- 100
Com_Ban_fit <- fitdist(rok_Com_Ban$liczba_zdarzen, "binom",fix.arg = list(size = size_value))
gofstat(Com_Ban_fit)

```

p-value wynosi 0,78 z tego powodu nie ma podstaw do odrzucenia hipotezy i mo偶emy uzna rozkad dwumianowy za dobrze dopasowany. Dla pewnoci zobaczymy to jeszcze na wykresie:

```{r}
plot(Com_Ban_fit)
```

Na czerwono widzimy rozkad teoretyczny, a na czarno empiryczny. Nie jest to dopasowanie idealne, ale podobne.

## Rozkad strat

Teraz bdziemy sprawdza dopasowanie funkcj fitdist, tym razem sprawdzamy dopasowanie rozkadu dotkliwoci strat do rozkad贸w lnorm, exp oraz gamma. Dopasowanie metod moment贸w (mme)

```{r}
Com_Ban2 <- fitdist(straty_Com_Ban$straty, method="mme","lnorm")
Com_Ban3 <- fitdist(straty_Com_Ban$straty, method="mme","exp")
Com_Ban4 <- fitdist(straty_Com_Ban$straty, method="mme","gamma")
names_test = c("lnorm", "exp", "gamma")

Result_Com_Ban<-gofstat(list(Com_Ban2, Com_Ban3, Com_Ban4), fitnames=names_test)
Result_Com_Ban$chisqpvalue
Result_Com_Ban$adtest
Result_Com_Ban$kstest
```

Ponownie zar贸wno rozkad lnorm jak i gamma m贸gby by dobrym kandydatem. Z tego powodu, zobaczmy to na wykresie.

-   Dla gammy:

```{r}
plot(fitdist(straty_Com_Ban$straty, "gamma"))

```

-   Dla lnorm:

```{r}
plot(fitdist(straty_Com_Ban$straty, "lnorm"))
```

Na wykresie mo偶emy zobaczy, 偶e rozkad teoretyczny gamma lepiej si dopasowuje, decydujemy si na wyb贸r **gamma**.

## Symulacja

Symulacja metod Monte Carlo bazujca na dw贸ch wczeniej wybranych rozkadach - dwumianowy oraz gamma.

```{r}
set.seed(123)
binom_params <- Com_Ban_fit$estimate 
prob_param <- binom_params["prob"]

gamma_params <- Com_Ban4$estimate
rate <- gamma_params["rate"]
shape <- gamma_params["shape"]
```

Parametry dopasowane metod maksymalnej wiarygodnoci dla rozkadu dwumianowgo: <br> prob_param = 0.06<br>

Parametry dopasowania gamma:<br> shape = 3.633469e+00<br> rate = 2.441848e-05<br>

<br> <br>

Symulujemy 20000 scenariuszy rocznych strat. Do ka偶dej symulacji wylosowano liczb zdarze z rozkadu dwumianowego. Dla ka偶dej liczby zdarze losujemy odpowiedni liczb strat z rozkadu gamma.

```{r}
n_sim <- 20000
size_param_binom <- 100

symulacje_Com_Ban <- replicate(n_sim, {
  liczba_zdarzen <- rbinom(1, size = size_param_binom, prob = prob_param)
  if (liczba_zdarzen == 0) return(0)
  sum(rexp(liczba_zdarzen, rate = rate))
})

```

Nastpnie na podstawie rozkadu symulowanego obliczamy OpVaR(99.9%) oraz OpES(99.9%).

```{r}
OpVaR_999_Com_Ban <- quantile(symulacje_Com_Ban, 0.999)
OpES_999_Com_Ban <- mean(symulacje_Com_Ban[symulacje_Com_Ban > OpVaR_999_Com_Ban])

hist_Com_Ban <-hist(symulacje_Com_Ban, breaks = 100, col = "lightblue",
     main = "Symulowany rozkad strat rocznych (Com_Ban)",
     xlab = "Suma strat")
abline(v = OpVaR_999_Com_Ban, col = "red", lwd = 2, lty = 2)

cat("OpVaR (99.9%) = ", OpVaR_999_Com_Ban, "\n")
cat("OpES  (99.9%) = ", OpES_999_Com_Ban, "\n")

```

Sporzdzilimy histogram symulowanego rozkadu strat, a na nim zaznaczona jest warto OpVaR. Na osi X mamy wielko straty, a na osi Y czstotliwo tych strat. Widzimy, 偶e rozkad jest mocno prawoskony z dugimi ogonami. Wikszo strat wynosi ok. 200000.

# linia Damage

## Rozkad czstotliwoci

```{r}
rok_Damage <- plik28 |>
  filter( linia == "Damage") |>
  group_by(rok) |>
  summarize(liczba_zdarzen = n())

straty_Damage <- plik28 |>
  filter(linia == "Damage") |>
  group_by(rok) |>
  summarize(straty = sum(strata, na.rm = TRUE))

Damage_summary <- merge(rok_Damage, straty_Damage, by = "rok")

kable(Damage_summary, format = "html", caption = "Podsumowanie dla liniii Damage") |> 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

```

Dane zostay przefiltrowane dla liniii Damage. Dla ka偶dego roku obliczono liczb zdarze oraz sum strat.

```{r}
mean_Damage = mean(rok_Damage$liczba_zdarzen)
sd_Damage = sd(rok_Damage$liczba_zdarzen)

mean_Damage
sd_Damage
```

rednia liczba zdarze to 14.09 a odchylenie standardowe 3.04. Na tej podstawie dopasowujemy rozkad dwumianowy, poniewa偶 gdy E(X) \> D\^2(X).

## Rozkad zdarze

Przyporzdkowalimy rozkad dwumianowy, z parametrem size=100. Dla pewnoci, sprawd藕my jeszcze dopasowanie funkcj "fitdistr":

```{r}
Damage_fit <- fitdist(rok_Damage$liczba_zdarzen, "binom",fix.arg = list(size = size_value))
gofstat(Damage_fit)
```

p-value wynosi 0,35 z tego powodu nie ma podstaw do odrzucenia hipotezy zerowej i mo偶emy uzna rozkad dwumianowy za dobrze dopasowany. Dla pewnoci zobaczymy to jeszcze na wykresie:

```{r}
plot(Damage_fit)
```

Widzimy, 偶e zwaszcza koo 14 rozkady sporo si rozje偶d偶aj, ale poza ni s cakiem nie藕le dopasowane do siebie.

## Rozkad strat

Bdziemy sprawdza dopasowanie funkcj fitdist, sprawdzamy dopasowanie rozkadu dotkliwoci strat do rozkad贸w lnorm, exp oraz gamma. Dopasowanie metod moment贸w (mme)

```{r}
Damage2 <- fitdist(straty_Damage$straty, method="mme","lnorm")
Damage3 <- fitdist(straty_Damage$straty, method="mme","exp")
Damage4 <- fitdist(straty_Damage$straty, method="mme","gamma")
names_test = c("lnorm", "exp", "gamma")

Result_Damage<-gofstat(list(Damage2, Damage3, Damage4), fitnames=names_test)
Result_Damage$chisqpvalue
Result_Damage$adtest
Result_Damage$kstest
```

呕aden test nie odrzuca dopasowania. Z tego powodu zobaczmy to na wykresie.

-   Dla gammy:

```{r}
plot(fitdist(straty_Com_Ban$straty, "gamma"))
```

-   Dla lnorm:

```{r}
plot(fitdist(straty_Com_Ban$straty, "lnorm"))
```

-   Dla exp:

```{r}
plot(fitdist(straty_Damage$straty, "exp"))
```

Na wykresie mo偶emy zobaczy, 偶e rozkad teoretyczny exp najlepiej si dopasowuje, decydujemy si na wyb贸r **exp**.

## Symulacja

Symulacja metod Monte Carlo bazujca na dw贸ch wczeniej wybranych rozkadach - dwumianowy oraz exp.

```{r}
set.seed(123)
binom_params2 <- Damage_fit$estimate 
prob_param2 <- binom_params2["prob"]

exp_params2 <- Damage3$estimate
rate2 <- exp_params2["rate"]
```

Parametry dla rozkadu dwumianowgo: <br> prob = 0.14<br>

Parametry dopasowania exp:<br> 1.034058e-05<br>

<br> <br>

Symulujemy 20000 scenariuszy rocznych strat. Do ka偶dej symulacji wylosowano liczb zdarze z rozkadu dwumianowego oraz straty dla ka偶dej szkody z rozkadu wykadniczego.

```{r}
n_sim <- 20000
size_param_binom2 <- 100

symulacje_Damage <- replicate(n_sim, {
  liczba_zdarzen <- rbinom(1, size = size_param_binom2, prob = prob_param2)
  if (liczba_zdarzen == 0) return(0)
  sum(rexp(liczba_zdarzen, rate = rate2))
})
```

Nastpnie na podstawie rozkadu symulowanego obliczamy OpVaR(99.9%) oraz OpES(99.9%).

```{r}
OpVaR_999_Damage <- quantile(symulacje_Damage, 0.999)
OpES_999_Damage <- mean(symulacje_Damage[symulacje_Damage > OpVaR_999_Damage])

hist_Damage <- hist(symulacje_Damage, breaks = 100, col = "lightblue",
     main = "Symulowany rozkad strat rocznych (Damage)",
     xlab = "Suma strat")
abline(v = OpVaR_999_Damage, col = "red", lwd = 2, lty = 2)

cat("OpVaR (99.9%) = ", OpVaR_999_Damage, "\n")
cat("OpES  (99.9%) = ", OpES_999_Damage, "\n")

```

Histogram symulowanego rozkadu strat, a na nim zaznaczona jest warto OpVaR. Na osi X mamy wielko straty, a na osi Y czstotliwo tych strat. Wikszo strat wynosi ok. 1500000. Widzimy, 偶e wykres dalej jest prawoskony, cho znacznie bardziej symetryczny ni偶 dla dw贸ch poprzednich linii. rednia dotkliwo jak i ich czstotliwo r贸wnie偶 jest wiksza.

# linia Empl_Pract

## Rozkad czstotliwoci

```{r}
rok_Empl_Pract <- plik28 |>
  filter( linia == "Empl_Pract") |>
  group_by(rok) |>
  summarize(liczba_zdarzen = n())

straty_Empl_Pract <- plik28 |>
  filter(linia == "Empl_Pract") |>
  group_by(rok) |>
  summarize(straty = sum(strata, na.rm = TRUE))



Damage_summary <- merge(rok_Empl_Pract, straty_Empl_Pract, by = "rok")

kable(Damage_summary, format = "html", caption = "Podsumowanie dla liniii Empl_Pract") |> 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

```

Dane zostay przefiltrowane dla liniii Empl_Pract Dla ka偶dego roku obliczono liczb zdarze oraz sum strat.

```{r}
mean_Empl_Pract = mean(rok_Empl_Pract$liczba_zdarzen)
sd_Empl_Pract = sd(rok_Empl_Pract$liczba_zdarzen)

mean_Empl_Pract
sd_Empl_Pract
```

rednia liczba zdarze to 213.54 a odchylenie standardowe 20.07. Na tej podstawie dopasowujemy rozkad ujemny dwumianowy, poniewa偶 gdy E(X) \< D\^2(X).

## Rozkad zdarze

Przyporzdkowalimy rozkad ujemny dwumianowy. Dla pewnoci, sprawd藕my jeszcze dopasowanie funkcj "fitdistr":

```{r}
Empl_Pract_fit <- fitdist(rok_Empl_Pract$liczba_zdarzen, "nbinom")
gofstat(Empl_Pract_fit)
```

p-value wynosi 0,82 z tego powodu nie ma podstaw do odrzucenia hipotezy zerowej i mo偶emy uzna rozkad ujemny dwumianowy za dobrze dopasowany. Dla pewnoci zobaczymy to jeszcze na wykresie:

```{r}
plot(Empl_Pract_fit)
```

Dobrze przyjrze si w tym przypadku na wykres dystrybuanty. Widzimy, 偶e dopasowanie jest nie najgorsze, rozje偶d偶a si przy ogonach, a zwaszcza tym z prawej, ale w rodku jest bardzo dobre.

## Rozkad strat

Bdziemy sprawdza dopasowanie funkcj fitdist, sprawdzamy dopasowanie rozkadu dotkliwoci strat do rozkad贸w weibull, lnorm, exp oraz gamma. Dopasowanie metod moment贸w (mme).

```{r}
Empl_Pract <- fitdist(straty_Empl_Pract$straty,"weibull")
Empl_Pract2 <- fitdist(straty_Empl_Pract$straty, method="mme","lnorm")
Empl_Pract3 <- fitdist(straty_Empl_Pract$straty, method="mme","exp")
Empl_Pract4 <- fitdist(straty_Empl_Pract$straty, method="mme","gamma")
names_test = c("weibull","lnorm", "exp", "gamma")

Result_Empl_Pract<-gofstat(list(Empl_Pract,Empl_Pract2, Empl_Pract3, Empl_Pract4), fitnames=names_test)
Result_Empl_Pract$chisqpvalue
Result_Empl_Pract$adtest
Result_Damage$kstest
```

呕aden test nie odrzuca dopasowania. Z tego powodu zobaczmy to na wykresie.

-   Dla lnorm:

```{r}
plot(fitdist(straty_Empl_Pract$straty, "lnorm"))

```

-   Dla gammy:

```{r}
plot(fitdist(straty_Empl_Pract$straty, "gamma"))
```

-   Dla weibulla:

```{r}
plot(fitdist(straty_Empl_Pract$straty, "weibull"))
```

-   Dla exp:

```{r}
plot(fitdist(straty_Empl_Pract$straty, "exp"))
```

Na wykresie mo偶emy zobaczy, 偶e rozkad teoretyczny gamma jest nieco lepiej dopasowany, decydujemy si na wyb贸r **gamma**.

## Symulacja

Symulacja metod Monte Carlo bazujca na dw贸ch wczeniej wybranych rozkadach - ujemnym dwumianowy oraz gamma.

```{r}
nbinom_params3 <- Empl_Pract_fit$estimate 
size_param3 <- nbinom_params3["size"]
mu_param3 <- nbinom_params3["mu"]

gamma_params3 <- Empl_Pract4$estimate
shape_param3 <- gamma_params3["shape"]
rate_param3 <- gamma_params3["rate"]
```

Parametry dla rozkadu ujemno-dwumianowgo: <br> size = 255.11<br> mu = 213.54<br>

Parametry dopasowania gamma:<br> shape = 1.092585e+02<br> rate = 1.461848e-05<br>

<br> <br>

Symulujemy 20000 scenariuszy rocznych strat. Do ka偶dej symulacji wylosowano liczb zdarze z rozkadu ujemnego-dwumianowego oraz straty dla ka偶dej szkody z rozkadu gamma.

```{r}
n_sim <- 20000 

symulacje_Empl_Pract <- replicate(n_sim, {
  liczba_zdarzen <- rnbinom(1, size = size_param3, mu = mu_param3)
  if (liczba_zdarzen == 0) return(0)
  sum(rgamma(liczba_zdarzen, shape = shape_param3, rate = rate_param3))
})
```

Nastpnie na podstawie rozkadu symulowanego obliczamy OpVaR(99.9%) oraz OpES(99.9%).

```{r}
OpVaR_999_Empl_Pract <- quantile(symulacje_Empl_Pract, 0.999)
OpES_999_Empl_Pract <- mean(symulacje_Empl_Pract[symulacje_Empl_Pract > OpVaR_999_Empl_Pract])

hist_Empl_Pract <- hist(symulacje_Empl_Pract, breaks = 100, col = "lightblue",
     main = "Symulowany rozkad strat rocznych (Empl_Pract)",
     xlab = "Suma strat")
abline(v = OpVaR_999_Empl_Pract, col = "red", lwd = 2, lty = 2)

# Wyniki
cat("OpVaR (99.9%) = ", OpVaR_999_Empl_Pract, "\n")
cat("OpES  (99.9%) = ", OpES_999_Empl_Pract, "\n")

```

Histogram symulowanego rozkadu strat, a na nim zaznaczona jest warto OpVaR. Na osi X mamy wielko straty, a na osi Y czstotliwo tych strat. Wikszo strat wynosi ok. 1.6e+09. Rozkad jest bardzo zbli偶ony do normalnego oraz posiada najwiksze do tej pory wielkoci strat zachowujac umiarkowan czstotliwo ich wystpowania co do roku.

# linia Execut_Del

## Rozkad czstotliwoci

```{r}
rok_Execut_Del <- plik28 |>
  filter( linia == "Execut_Del") |>
  group_by(rok) |>
  summarize(liczba_zdarzen = n())

straty_Execut_Del <- plik28 |>
  filter(linia == "Execut_Del") |>
  group_by(rok) |>
  summarize(straty = sum(strata, na.rm = TRUE))

Exe_summary <- merge(rok_Execut_Del, straty_Execut_Del, by = "rok")

kable(Exe_summary, format = "html", caption = "Podsumowanie dla liniii Execut_Del") |> 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

```

Dane zostay przefiltrowane dla liniii Execut_Del. Dla ka偶dego roku obliczono liczb zdarze oraz sum strat.

```{r}

mean_Execut_Del = mean(rok_Execut_Del$liczba_zdarzen)
sd_Execut_Del = sd(rok_Execut_Del$liczba_zdarzen)

mean_Execut_Del
sd_Execut_Del
```

rednia liczba zdarze to 7.11 a odchylenie standardowe 2.28. Na tej podstawie dopasowujemy rozkad dwumianowy, poniewa偶 gdy E(X) \> D\^2(X).

## Rozkad zdarze

Przyporzdkowalimy rozkad dwumianowy. Dla pewnoci, sprawd藕my jeszcze dopasowanie funkcj "fitdistr":

```{r}
Execut_Del_fit <- fitdist(rok_Execut_Del$liczba_zdarzen, "binom",fix.arg = list(size = size_value))
gofstat(Execut_Del_fit)
```

p-value wynosi 0,64 z tego powodu nie ma podstaw do odrzucenia hipotezy zerowej i mo偶emy uzna rozkad dwumianowy za dobrze dopasowany. Dla pewnoci zobaczymy to jeszcze na wykresie:

```{r}
plot(Execut_Del_fit)
```

Rozkad wydaje si by dobrze dopasowany, gsto rozkadu empirycznego wydaje si dla ka偶dej wartoci nieco wiksza, wyjtkiem jest punkt 5, kt贸y nie wystpuje dla naszych danych. Tak czy inaczej rozkad binom wydaje si sensowny.

## Rozkad strat

Bdziemy sprawdza dopasowanie funkcj fitdist, sprawdzamy dopasowanie rozkadu dotkliwoci strat do rozkad贸w weibull, lnorm, exp oraz gamma. Dopasowanie metod moment贸w (mme).

```{r}
Execut_Del1 <- fitdist(straty_Execut_Del$straty, "weibull")
Execut_Del2 <- fitdist(straty_Execut_Del$straty, method="mme","lnorm")
Execut_Del3 <- fitdist(straty_Execut_Del$straty, method="mme","exp")
Execut_Del4 <- fitdist(straty_Execut_Del$straty, method="mme","gamma")
names_test = c("Weibull","lnorm", "exp", "gamma")

Result_Execut_Del<-gofstat(list(Execut_Del1, Execut_Del2,Execut_Del3,Execut_Del4), fitnames=names_test)
Result_Execut_Del$chisqpvalue
Result_Execut_Del$adtest
Result_Execut_Del$kstest
```

Tylko w przypadku kstest exp zostao odrzucone, reszta nieodrzucona. Z tego powodu zobaczmy to na wykresie.

-   Dla weibull:

```{r}
plot(fitdist(straty_Execut_Del$straty, "weibull"))

```

-   Dla gammy:

```{r}
plot(fitdist(straty_Execut_Del$straty, "gamma"))
```

Wybieramy dopasowanie do rozkadu weibulla.

## Symulacja

Symulacja metod Monte Carlo bazujca na dw贸ch wczeniej wybranych rozkadach - ujemnym dwumianowy oraz gamma.

```{r}
set.seed(123)

binom_params_exec <- Execut_Del_fit$estimate
prob_param_exec <- binom_params_exec["prob"]


weibull_params_exec <- Execut_Del1$estimate
shape_exec <- weibull_params_exec["shape"]
scale_exec <- weibull_params_exec["scale"]

```

Parametry dla rozkadu dwumianowego: <br> prob = 0.71<br>

Parametry dopasowania weibulla:<br> shape = 1.95<br> scale = 42473.57<br>

<br> <br>

Symulujemy 20000 scenariuszy rocznych strat. Do ka偶dej symulacji wylosowano liczb zdarze z rozkadu dwumianowego oraz straty dla ka偶dej szkody z rozkadu weibulla.

```{r}
n_sim <- 20000
size_param_binom <- 100

symulacje_Execut_Del <- replicate(n_sim, {
  liczba_zdarzen <- rbinom(1, size = size_param_binom, prob = prob_param_exec)
  if (liczba_zdarzen == 0) return(0)
  sum(rweibull(liczba_zdarzen, shape = shape_exec, scale = scale_exec))
})
```

Nastpnie na podstawie rozkadu symulowanego obliczamy OpVaR(99.9%) oraz OpES(99.9%).

```{r}
OpVaR_999_Execut_Del <- quantile(symulacje_Execut_Del, 0.999)
OpES_999_Execut_Del <- mean(symulacje_Execut_Del[symulacje_Execut_Del > OpVaR_999_Execut_Del])

hist_Execut_Del <- hist(symulacje_Execut_Del, breaks = 100, col = "lightblue",
     main = "Symulowany rozkad strat (Execut_Del)", xlab = "Suma strat")
abline(v = OpVaR_999_Execut_Del, col = "red", lwd = 2, lty = 2)

cat("OpVaR (99.9%) = ", OpVaR_999_Execut_Del, "\n")
cat("OpES  (99.9%) = ", OpES_999_Execut_Del, "\n")

```

Histogram symulowanego rozkadu strat, a na nim zaznaczona jest warto OpVaR. Na osi X mamy wielko straty, a na osi Y czstotliwo tych strat. Wikszo strat wynosi ok. 2e+05.Rozkad jest znacznie prawoskony. Straty s umiarkowanie dotkliwe.

# linia External_Fr

## Rozkad czstotliwoci

```{r}
rok_External_Fr <- plik28 |>
  filter( linia == "External_Fr") |>
  group_by(rok) |>
  summarize(liczba_zdarzen = n())


straty_External_Fr <- plik28 |>
  filter(linia == "External_Fr") |>
  group_by(rok) |>
  summarize(straty = sum(strata, na.rm = TRUE))


Ext_summary <- merge(rok_External_Fr, straty_External_Fr, by = "rok")

kable(Ext_summary, format = "html", caption = "Podsumowanie dla liniii External_Fr") |> 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

```

Dane zostay przefiltrowane dla liniii Execut_Del. Dla ka偶dego roku obliczono liczb zdarze oraz sum strat.

```{r}

mean_External_Fr = mean(rok_External_Fr$liczba_zdarzen)
sd_External_Fr = sd(rok_External_Fr$liczba_zdarzen)
mean_External_Fr
sd_External_Fr

```

rednia liczba zdarze to 11.2 a odchylenie standardowe 2.37. Na tej podstawie dopasowujemy rozkad dwumianowy, poniewa偶 gdy E(X) \> D\^2(X).

## Rozkad zdarze

Przyporzdkowalimy rozkad dwumianowy. Dla pewnoci, sprawd藕my jeszcze dopasowanie funkcj "fitdistr":

```{r}
External_Fr_fit <- fitdist(rok_External_Fr$liczba_zdarzen, "binom",fix.arg = list(size = size_value))
gofstat(External_Fr_fit)

```

p-value wynosi 0,08 z tego powodu nie ma podstaw do odrzucenia hipotezy zerowej i mo偶emy uzna rozkad dwumianowy za dobrze dopasowany. Dla pewnoci zobaczymy to jeszcze na wykresie:

```{r}
plot(External_Fr_fit)
```

Po stosunkowo niskim p-value mo偶naby byo spodziewa si sporych r贸偶nic midzy rozkadem empirycznym a teoretycznym. Jednak z braku lepszych opcji wybierzemy wanie jego.

## Rozkad strat

Bdziemy sprawdza dopasowanie funkcj fitdist, sprawdzamy dopasowanie rozkadu dotkliwoci strat do rozkad贸w weibull, lnorm, exp oraz gamma. Dopasowanie metod moment贸w (mme).

```{r}
External_Fr1 <- fitdist(straty_External_Fr$straty, "weibull")
External_Fr2 <- fitdist(straty_External_Fr$straty, method="mme","lnorm")
External_Fr3 <- fitdist(straty_External_Fr$straty, method="mme","exp")
External_Fr4 <- fitdist(straty_External_Fr$straty, method="mme","gamma")
names_test = c("Weibull","lnorm", "exp", "gamma")

Result_External_Fr<-gofstat(list(External_Fr1, External_Fr2,External_Fr3,External_Fr4), fitnames=names_test)
Result_External_Fr$chisqpvalue
Result_External_Fr$adtest
Result_External_Fr$kstest

```

Tylko w przypadku kstest exp zostao odrzucone, reszta nieodrzucona. Z tego powodu zobaczmy to na wykresie.

-   Dla lnorm:

```{r}
plot(fitdist(straty_External_Fr$straty, "lnorm"))

```

-   Dla gammy:

```{r}
plot(fitdist(straty_External_Fr$straty, "gamma"))

```

Wybieramy dopasowanie do rozkadu Lnorm.

## Symulacja

Symulacja metod Monte Carlo bazujca na dw贸ch wczeniej wybranych rozkadach - dwumianowy oraz Lnorm.

```{r}
set.seed(123)

binom_params_ext <- External_Fr_fit$estimate
prob_param_ext <- binom_params_ext["prob"]

lnorm_params_ext <- External_Fr2$estimate
meanlog_ext <- lnorm_params_ext["meanlog"]
sdlog_ext <- lnorm_params_ext["sdlog"]


```

Parametry dla rozkadu dwumianowego: <br> prob = 0.11<br>

Parametry dopasowania Lnorm:<br> meanlog = 10.37<br> sdlog = 0.43<br>

<br> <br>

Symulujemy 20000 scenariuszy rocznych strat. Do ka偶dej symulacji wylosowano liczb zdarze z rozkadu dwumianowego oraz straty dla ka偶dej szkody z rozkadu Lnorm.

```{r}
symulacje_External_Fr <- replicate(n_sim, {
  liczba_zdarzen <- rbinom(1, size = size_param_binom, prob = prob_param_ext)
  if (liczba_zdarzen == 0) return(0)
  sum(rlnorm(liczba_zdarzen, meanlog = meanlog_ext, sdlog = sdlog_ext))
})


```

Nastpnie na podstawie rozkadu symulowanego obliczamy OpVaR(99.9%) oraz OpES(99.9%).

```{r}
OpVaR_999_External_Fr <- quantile(symulacje_External_Fr, 0.999)
OpES_999_External_Fr <- mean(symulacje_External_Fr[symulacje_External_Fr > OpVaR_999_External_Fr])

hist_External_Fr <- hist(symulacje_External_Fr, breaks = 100, col = "lightblue",
     main = "Symulowany rozkad strat (External_Fr)", xlab = "Suma strat")
abline(v = OpVaR_999_External_Fr, col = "red", lwd = 2, lty = 2)

cat("OpVaR (99.9%) = ", OpVaR_999_External_Fr, "\n")
cat("OpES  (99.9%) = ", OpES_999_External_Fr, "\n")

```

Histogram symulowanego rozkadu strat, a na nim zaznaczona jest warto OpVaR. Na osi X mamy wielko straty, a na osi Y czstotliwo tych strat. Wikszo strat wynosi ok. 350000. Wykres jest lekko prawoskony.

# linia Internal_Fr

## Rozkad czstotliwoci

```{r}
rok_Internal_Fr <- plik28 |>
  filter( linia == "Internal_Fr") |>
  group_by(rok) |>
  summarize(liczba_zdarzen = n())

straty_Internal_Fr <- plik28 |>
  filter(linia == "Internal_Fr") |>
  group_by(rok) |>
  summarize(straty = sum(strata, na.rm = TRUE))



Int_summary <- merge(rok_Internal_Fr, straty_Internal_Fr, by = "rok")

kable(Int_summary, format = "html", caption = "Podsumowanie dla liniii Internal_Fr") |> 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F)

```

Dane zostay przefiltrowane dla liniii Execut_Del. Dla ka偶dego roku obliczono liczb zdarze oraz sum strat.

```{r}

mean_Internal_Fr = mean(rok_Internal_Fr$liczba_zdarzen)
sd_Internal_Fr = sd(rok_Internal_Fr$liczba_zdarzen)
mean_Internal_Fr
sd_Internal_Fr

```

rednia liczba zdarze to 187.6 a odchylenie standardowe 21.9. Na tej podstawie dopasowujemy rozkad ujemny dwumianowy, poniewa偶 gdy E(X) \< D\^2(X).

## Rozkad zdarze

Przyporzdkowalimy rozkad ujemny dwumianowy. Dla pewnoci, sprawd藕my jeszcze dopasowanie funkcj "fitdistr":

```{r}
Internal_Fr_fit <- fitdist(rok_Internal_Fr$liczba_zdarzen, "nbinom")
gofstat(Internal_Fr_fit)

```

p-value wynosi 0.16 z tego powodu nie ma podstaw do odrzucenia hipotezy zerowej i mo偶emy uzna rozkad ujemny dwumianowy za dobrze dopasowany. Dla pewnoci zobaczymy to jeszcze na wykresie:

```{r}
plot(Internal_Fr_fit)
```

Ponowie kierujc spojrzenie na rozkad dystrybuanty mo偶na uzna, 偶e rozkad zosta w tym przypadku zdecydowanie dobrze przyporzdkowany.

## Rozkad strat

Bdziemy sprawdza dopasowanie funkcj fitdist, sprawdzamy dopasowanie rozkadu dotkliwoci strat do rozkad贸w lnorm, exp oraz gamma. Dopasowanie metod moment贸w (mme).

```{r}
Internal_Fr2 <- fitdist(straty_Internal_Fr$straty, method="mme","lnorm")
Internal_Fr3 <- fitdist(straty_Internal_Fr$straty, method="mme","exp")
Internal_Fr4 <- fitdist(straty_Internal_Fr$straty, method="mme","gamma")
names_test = c("lnorm", "exp", "gamma")

Result_Internal_Fr<-gofstat(list(Internal_Fr2, Internal_Fr3,Internal_Fr4), fitnames=names_test)
Result_Internal_Fr$chisqpvalue
Result_Internal_Fr$adtest
Result_Internal_Fr$kstest


```

Tylko w przypadku kstest exp zostao odrzucone, reszta nieodrzucona. Z tego powodu zobaczmy to na wykresie.

-   Dla lnorm:

```{r}
plot(fitdist(straty_Internal_Fr$straty, "lnorm"))

```

-   Dla gammy:

```{r}

plot(fitdist(straty_Internal_Fr$straty, "gamma"))

```

Wybieramy dopasowanie do rozkadu Lnorm.

## Symulacja

Symulacja metod Monte Carlo bazujca na dw贸ch wczeniej wybranych rozkadach - ujemny dwumianowy oraz Lnorm.

```{r}
set.seed(123)

# Parametry nbinom
nbinom_params_int <- Internal_Fr_fit$estimate
size_param_int <- nbinom_params_int["size"]
mu_param_int <- nbinom_params_int["mu"]

# Parametry log-normal
lnorm_params_int <- Internal_Fr2$estimate
meanlog_int <- lnorm_params_int["meanlog"]
sdlog_int <- lnorm_params_int["sdlog"]


```

Parametry dla rozkadu ujemnego dwumianowego: <br> size = 127.88<br> mu = 187.59<br>

Parametry dopasowania Lnorm:<br> meanlog = 13.75<br> sdlog = 0.15<br>

<br> <br>

Symulujemy 20000 scenariuszy rocznych strat. Do ka偶dej symulacji wylosowano liczb zdarze z rozkadu ujemnego dwumianowego oraz straty dla ka偶dej szkody z rozkadu Lnorm.

```{r}
symulacje_Internal_Fr <- replicate(n_sim, {
  liczba_zdarzen <- rnbinom(1, size = size_param_int, mu = mu_param_int)
  if (liczba_zdarzen == 0) return(0)
  sum(rlnorm(liczba_zdarzen, meanlog = meanlog_int, sdlog = sdlog_int))
})


```

Nastpnie na podstawie rozkadu symulowanego obliczamy OpVaR(99.9%) oraz OpES(99.9%).

```{r}
OpVaR_999_Internal_Fr <- quantile(symulacje_Internal_Fr, 0.999)
OpES_999_Internal_Fr <- mean(symulacje_Internal_Fr[symulacje_Internal_Fr > OpVaR_999_Internal_Fr])

hist_Internal_Fr <- hist(symulacje_Internal_Fr, breaks = 100, col = "lightblue",
     main = "Symulowany rozkad strat (Internal_Fr)", xlab = "Suma strat")
abline(v = OpVaR_999_Internal_Fr, col = "red", lwd = 2, lty = 2)

cat("OpVaR (99.9%) = ", OpVaR_999_Internal_Fr, "\n")
cat("OpES  (99.9%) = ", OpES_999_Internal_Fr, "\n")


```

Histogram symulowanego rozkadu strat, a na nim zaznaczona jest warto OpVaR. Na osi X mamy wielko straty, a na osi Y czstotliwo tych strat. Wikszo strat wynosi ok. 17000000. Rozkad jest symetyczny, jest lekko "wy偶szy", ni偶 normalny.

# Podsumowanie

```{r}
## tabelka podsumowujca:
symulacje_df <- data.frame(
  Scenariusz = 1:n_sim,
  BussDist = symulacje_BussDist,
  Com_Ban = symulacje_Com_Ban,
  Damage = symulacje_Damage,
  Empl_Pract = symulacje_Empl_Pract,
  Execut_Del = symulacje_Execut_Del,
  External_Fr = symulacje_External_Fr,
  Internal_Fr = symulacje_Internal_Fr
)

# Dodanie kolumny z sum strat dla ka偶dego scenariusza
symulacje_df$Suma <- rowSums(symulacje_df[, -1])

# Podgld

kable(head(symulacje_df,20), caption = "Tabela 1: Wielko strat w kontekcie scenariuszy:", 
      align = "lrr", format = "markdown")

```

Dziki temu zestawieniu mo偶emy zobaczy, jak w konkretnym scenariuszu bdzie wygldaa suma opVaru 999.

```{r}
library(tibble)
library(dplyr)

# Tabela ze wska藕nikami
tabela_oprisk <- tibble(
  linia_Biznesowa = c("Business Disruption", "Commercial Banking", "Damage to Assets", 
                      "Employment Practices", "Execution & Delivery", 
                      "External Fraud", "Internal Fraud"),
  OpVaR_999 = c(OpVaR_999_BussDist, OpVaR_999_Com_Ban, OpVaR_999_Damage,
                OpVaR_999_Empl_Pract, OpVaR_999_Execut_Del,
                OpVaR_999_External_Fr, OpVaR_999_Internal_Fr),
  OpES_999 = c(OpES_999_BussDist, OpES_999_Com_Ban, OpES_999_Damage,
               OpES_999_Empl_Pract, OpES_999_Execut_Del,
               OpES_999_External_Fr, OpES_999_Internal_Fr)
) %>%
  mutate(across(OpVaR_999:OpES_999, round, 2))


# Wywietlenie tabeli
library(knitr)

kable(tabela_oprisk, caption = "Tabela 2: Wska藕niki OpVaR i OpES dla poszczeg贸lnych liniii biznesowych", 
      align = "lrr", format = "markdown")

```

Tabela zestawia Var 99 oraz strat dla ka偶dej z 7 linii biznesowych. Widzimy zdecydowanie najwy偶sze wartoci dla Employment Practises. Prawdopodobnie chodzi tu o mo偶liwe naruszenia praw przez pracownik贸w. Dla bank贸w jest to szczeg贸lnie dotkliwe ryzyko, poniewa偶 mo偶e skutkowa oszustwami i pr贸bami wyudzania np. kredytu co mo偶e by opakane w skutkach dla danego banku.

Najni偶sz strat posiada Execution & Delivery. Problemy zwizane z dostaw cho mog by kosztowne jak widzimy s najmniejszym zmartwieniem dla bank贸w.

Por贸wnujc wartoci dla OpVaru 999 widzimy jak z wielkim ryzykiem straty wi偶e si praca bank贸w. Powinny mie one ogromne poduszki finansowe lub jakie innego typu zabezpieczenia, kt贸re pomogy by w przypadku nasilenia si problem贸w.

Zobaczmy jeszcze razem na rozkady wynik贸 symulacji dla ka偶dej z linii. Mo偶na zauwa偶y, 偶e wikszo z nich jest zdecydowanei prawo-skona. Nieliczne z nich s troch bardziej scentrowane.

```{r}
library(gridExtra)

par(mfrow = c(3, 3), mar = c(4, 4, 2, 1))
plot(hist_BussDist)
plot(hist_Com_Ban)
plot(hist_Damage)
plot(hist_Empl_Pract)
plot(hist_Execut_Del)
plot(hist_External_Fr)
plot(hist_Internal_Fr)
```

**Wnioski**

Zr贸偶nicowane ryzyko w liniach biznesowych: Wysokie wartoci VaR 99 i strat w Employment Practices wskazuj na znaczce ryzyko prawne zwizane z dziaaniami pracownik贸w. Cho inne liniie, takie jak Execution & Delivery, pokazuj mniejsze straty, to nie oznacza to, 偶e nie wi偶 si z 偶adnym ryzykiem. Problem dostaw mo偶e mie wpyw na reputacj i koszty operacyjne, ale nie jest r贸wnie gro藕ny jak ryzyko oszustw w bankowoci.

Zabezpieczenia finansowe w bankach: Analiza VaR 99 pokazuje, 偶e banki powinny posiada solidne zabezpieczenia finansowe, aby radzi sobie z potencjalnymi stratami. Wysokie ryzyko w liniach zwizanych z bankowoci wymaga odpowiednich mechanizm贸w ochrony przed takimi zdarzeniami.

Niejednorodno rozkad贸w strat: Wikszo rozkad贸w strat wykazuje charakter prawoskony, co mo偶e sugerowa, 偶e wikszo strat jest stosunkowo niewielka, ale niekt贸re incydenty mog powodowa wyjtkowo du偶e straty. To podkrela, jak istotne jest monitorowanie i modelowanie ryzyka skrajnych zdarze.
